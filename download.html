<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="download.css">
    <title>GR AfCFTA 2100</title>
</head>

<body>
    <div class="card">
        <!-- Image du header -->
        <img src="pdf/imgdownload.jpg" alt="Card Image">

        <!-- Contenu -->
        <div class="card-content">
            <h3 id="INDEXID1"></h3>
            <p id="INDEXID2"></p>
        </div>

        <!-- Footer avec compteur et bouton -->
        <div class="card-footer">
            <span class="downloads" id="downloadCount" style="display: flex;">
                <p id="downloadsCount">

                </p>&nbsp;
                <p id="INDEXID6">

                </p>
            </span>
            <button class="btn-download" id="downloadBtn">
                <!-- IcÃ´ne Download -->

            </button>
        </div>
    </div>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- i18next -->
    <script src="https://unpkg.com/i18next@23.4.6/dist/umd/i18next.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCaZ2ayLosWDbF3-iu0CTr2EbvtWdGCKCk",
            authDomain: "comming-grafcfta2100.firebaseapp.com",
            databaseURL: "https://comming-grafcfta2100-default-rtdb.firebaseio.com",
            projectId: "comming-grafcfta2100",
            storageBucket: "comming-grafcfta2100.firebasestorage.app",
            messagingSenderId: "417932287789",
            appId: "1:417932287789:web:1385328615c9b4ca327da4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const params = new URLSearchParams(window.location.search);
        const savedLangpdf = params.get("lang") || "fr";
        // Init i18next avec resources intÃ©grÃ©es
        i18next.init({
            lng: savedLangpdf, // Langue par dÃ©faut
            resources: {
                en: {
                    translation: {
                        "INDEXID1": `SUPPORTING AFRICAâ€™S CATCH-UP AND GEO-ECONOMIC EXPANSION TOWARDS 2100`,
                        "INDEXID2": `<strong>GR-AfCFTA 2100 :</strong> A Strategic  Support Plan for Africaâ€™s Catch-Up and Geo-Economic Expansion towards 2100
                                `,
                        "INDEXID6": `Downloads`,
                        "INDEXID7": `Download`,
                        "downloadBtn": `  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 3v12m0 0l4-4m-4 4l-4-4m-5 8h18" stroke="white" stroke-width="2" fill="none"
                            stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Download`,
                        "downloadTitle": "Download the programme overview",
                        "name": "Your name",
                        "email": "Your email",
                        "errorFields": "Please fill in all fields",
                        "accessDeniedTitle": "Access denied",
                        "accessDeniedMsg": "This email has already downloaded the document.",
                        "loadingTitle": "Downloading...",
                        "loadingText": "Please wait",
                        "successTitle": "Congratulations ðŸŽ‰",
                        "successText": "Your download has started successfully!"
                    }
                },
                fr: {
                    translation: {
                        "INDEXID1": `ACCOMPAGNER LE RATTRAPAGE ET Lâ€™EXPANSION GÃ‰OÃ‰CONOMIQUE DE Lâ€™AFRIQUE Ã€ Lâ€™HORIZON 2100.`,
                        "INDEXID2": `<strong>GR-AfCFTA 2100 :</strong> <b>Un Plan dâ€™appui stratÃ©gique pour le rattrapage et lâ€™expansion gÃ©oÃ©conomique de lâ€™Afrique Ã  lâ€™horizon 2100</b>`,
                        "INDEXID6": `tÃ©lÃ©chargements`,
                        "INDEXID7": `TÃ©lÃ©charger`,
                        "downloadBtn": `  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 3v12m0 0l4-4m-4 4l-4-4m-5 8h18" stroke="white" stroke-width="2" fill="none"
                        stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        TÃ©lÃ©charger`,
                        "downloadTitle": "TÃ©lÃ©charger l'aperÃ§u du programme",
                        "name": "Votre nom",
                        "email": "Votre email",
                        "errorFields": "Merci de remplir tous les champs",
                        "accessDeniedTitle": "AccÃ¨s refusÃ©",
                        "accessDeniedMsg": "Cet email a dÃ©jÃ  tÃ©lÃ©chargÃ© le document.",
                        "loadingTitle": "TÃ©lÃ©chargement en cours...",
                        "loadingText": "Merci de patienter",
                        "successTitle": "FÃ©licitations ðŸŽ‰",
                        "successText": "Votre tÃ©lÃ©chargement a dÃ©marrÃ© avec succÃ¨s !"
                    }
                }
            }
        }).then(() => {
            document.getElementById("INDEXID1").innerHTML = i18next.t("INDEXID1");
            document.getElementById("INDEXID2").innerHTML = i18next.t("INDEXID2");
            document.getElementById("INDEXID6").innerHTML = i18next.t("INDEXID6");
            //document.getElementById("INDEXID7").innerHTML = i18next.t("INDEXID7");
            document.getElementById("downloadBtn").innerHTML = i18next.t("downloadBtn");

        });

        async function runApp() {
            const params = new URLSearchParams(window.location.search);
            const savedLangpdf = params.get("lang") || "en"; // rÃ©cupÃ¨re ?lang=

            // force la langue
            await i18next.changeLanguage(savedLangpdf);

            // Ouvre directement le formulaire
            const { value: formValues } = await Swal.fire({
                title: i18next.t("downloadTitle"),
                html: `
            <input id="swal-name" class="swal2-input" placeholder="${i18next.t(" name")}" required>
            <input id="swal-email" type="email" class="swal2-input" placeholder="${i18next.t(" email")}" required>
            `,
                focusConfirm: false,
                allowOutsideClick: false,
                preConfirm: () => {
                    const name = document.getElementById("swal-name").value.trim();
                    const email = document.getElementById("swal-email").value.trim();
                    if (!name || !email) {
                        Swal.showValidationMessage(i18next.t("errorFields"));
                        return false;
                    }
                    return { name, email };
                }
            });

            if (!formValues) return;

            const { name, email } = formValues;
            const pdfUrlFr = "pdf/AperÃ§u-du-Programme-GR AfCFTA 2100-1.pdf";
            const pdfUrlEn = "pdf/Overview-of-GR-AfcFTA-2100.pdf";
            const selectedPdfBase64Url = savedLangpdf === "fr" ? pdfUrlFr : pdfUrlEn;
            const fileName = savedLangpdf === "fr" ? "GR_AfcFTA_2100_FR.pdf" : "GR_AfcFTA_2100_EN.pdf";

            // VÃ©rifie email dÃ©jÃ  utilisÃ©
            const snapshot = await get(child(ref(db), "isdownloads/" + btoa(email)));
            if (snapshot.exists()) {
                Swal.fire({
                    icon: "error",
                    title: i18next.t("accessDeniedTitle"),
                    text: i18next.t("accessDeniedMsg")
                });
                return;
            }

            // Spinner
            Swal.fire({
                title: i18next.t("loadingTitle"),
                text: i18next.t("loadingText"),
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // Sauvegarde en DB
            await set(ref(db, "isdownloads/" + btoa(email)), {
                name,
                email,
                lang: savedLangpdf,
                date: new Date().toISOString()
            });

            // TÃ©lÃ©chargement du fichier
            const link = document.createElement("a");
            link.href = selectedPdfBase64Url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // SuccÃ¨s
            Swal.fire({
                icon: "success",
                title: i18next.t("successTitle"),
                text: i18next.t("successText")
            });
        }

        // Attacher l'Ã©vÃ©nement au bouton
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById("downloadBtn");
            btn.addEventListener("click", async () => {
                await runApp();
            });
        });


        // RÃ©cupÃ©rer le total des tÃ©lÃ©chargements
        async function getTotalDownloads() {
            const snapshot = await get(ref(db, "isdownloads"));
            if (snapshot.exists()) {
                const data = snapshot.val();
                // Object.keys(data).length = nombre total dâ€™entrÃ©es (donc dâ€™emails uniques)
                return Object.keys(data).length;
            } else {
                return 0;
            }
        }

        // Afficher le nombre dans ton card
        async function showDownloadsCount() {
            const count = await getTotalDownloads();
            document.getElementById("downloadsCount").textContent = count;
        }

        // Charger automatiquement au dÃ©marrage
        document.addEventListener("DOMContentLoaded", () => {
            showDownloadsCount();
        });

    </script>
</body>

</html>