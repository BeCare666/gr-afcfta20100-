<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GR AfCFTA 2100</title>
</head>

<body>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- i18next -->
    <script src="https://unpkg.com/i18next@23.4.6/dist/umd/i18next.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getDatabase, ref, get, set, child } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCaZ2ayLosWDbF3-iu0CTr2EbvtWdGCKCk",
            authDomain: "comming-grafcfta2100.firebaseapp.com",
            databaseURL: "https://comming-grafcfta2100-default-rtdb.firebaseio.com",
            projectId: "comming-grafcfta2100",
            storageBucket: "comming-grafcfta2100.firebasestorage.app",
            messagingSenderId: "417932287789",
            appId: "1:417932287789:web:1385328615c9b4ca327da4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Init i18next avec resources int√©gr√©es
        i18next.init({
            lng: "en", // Langue par d√©faut
            resources: {
                en: {
                    translation: {
                        "downloadTitle": "Program Download",
                        "name": "Your name",
                        "email": "Your email",
                        "errorFields": "Please fill in all fields",
                        "accessDeniedTitle": "Access denied",
                        "accessDeniedMsg": "This email has already downloaded the document.",
                        "loadingTitle": "Downloading...",
                        "loadingText": "Please wait",
                        "successTitle": "Congratulations üéâ",
                        "successText": "Your download has started successfully!"
                    }
                },
                fr: {
                    translation: {
                        "downloadTitle": "T√©l√©chargement du programme",
                        "name": "Votre nom",
                        "email": "Votre email",
                        "errorFields": "Merci de remplir tous les champs",
                        "accessDeniedTitle": "Acc√®s refus√©",
                        "accessDeniedMsg": "Cet email a d√©j√† t√©l√©charg√© le document.",
                        "loadingTitle": "T√©l√©chargement en cours...",
                        "loadingText": "Merci de patienter",
                        "successTitle": "F√©licitations üéâ",
                        "successText": "Votre t√©l√©chargement a d√©marr√© avec succ√®s !"
                    }
                }
            }
        }).then(() => {
            runApp();
        });

        async function runApp() {
            const params = new URLSearchParams(window.location.search);
            const savedLangpdf = params.get("lang") || "en"; // r√©cup√®re ?lang=

            // force la langue
            await i18next.changeLanguage(savedLangpdf);

            window.addEventListener("load", async () => {
                const { value: formValues } = await Swal.fire({
                    title: i18next.t("downloadTitle"),
                    html: `
            <input id="swal-name" class="swal2-input" placeholder="${i18next.t("name")}" required>
            <input id="swal-email" type="email" class="swal2-input" placeholder="${i18next.t("email")}" required>
          `,
                    focusConfirm: false,
                    allowOutsideClick: false,
                    preConfirm: () => {
                        const name = document.getElementById("swal-name").value.trim();
                        const email = document.getElementById("swal-email").value.trim();
                        if (!name || !email) {
                            Swal.showValidationMessage(i18next.t("errorFields"));
                            return false;
                        }
                        return { name, email };
                    }
                });

                if (!formValues) return;

                const { name, email } = formValues;
                const pdfUrl = "pdf/Aper√ßu-du-Programme-GR AfCFTA 2100-1.pdf";
                const pdfUrlen = "pdf/Overview-of-GR-AfcFTA-2100.pdf";
                const selectedPdfBase64Url = savedLangpdf === "fr" ? pdfUrl : pdfUrlen;
                const fileName = savedLangpdf === "fr" ? "GR_AfcFTA_2100_FR.pdf" : "GR_AfcFTA_2100_EN.pdf";

                // V√©rifie email
                const snapshot = await get(child(ref(db), "downloads/" + btoa(email)));
                if (snapshot.exists()) {
                    Swal.fire({
                        icon: "error",
                        title: i18next.t("accessDeniedTitle"),
                        text: i18next.t("accessDeniedMsg")
                    });
                    return;
                }

                // Spinner
                Swal.fire({
                    title: i18next.t("loadingTitle"),
                    text: i18next.t("loadingText"),
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                // Save en DB
                await set(ref(db, "downloads/" + btoa(email)), {
                    name,
                    email,
                    lang: savedLangpdf,
                    date: new Date().toISOString()
                });

                // T√©l√©chargement fichier
                const link = document.createElement("a");
                link.href = selectedPdfBase64Url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Success
                Swal.fire({
                    icon: "success",
                    title: i18next.t("successTitle"),
                    text: i18next.t("successText")
                });
            });
        }
    </script>
</body>

</html>